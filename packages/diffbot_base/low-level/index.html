
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="ROS Base Package for ROS Noetic running on a Raspberry Pi 4 for an autonomous 2WD Robot to act in an environment according to sensor information. This describes the implementation of the diffbot_base package following the low-level approach." name="description"/>
<link href="https://ros-mobile-robots.com/packages/diffbot_base/low-level/" rel="canonical"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.2, mkdocs-material-8.5.10" name="generator"/>
<title>Base Package - Low Level Approach - DiffBot Differential Drive Mobile Robot</title>
<link href="../../../assets/stylesheets/main.975780f9.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.2505c338.min.css" rel="stylesheet"/>
<script src="../../../js/jquery-3.5.1.min.js"></script>
<script src="../../../js/jquery.fitvids.js"></script>
<!-- Arithmatex -->
<!-- MathJax
        <script src="../../../js/mathjax.js"></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        -->
<!-- KaTeX -->
<script src="../../../js/katex.js"></script>
<script crossorigin="anonymous" integrity="sha256-F/Xda58SPdcUCr+xhSGz9MA2zQBPb0ASEYKohl8UCHc=" src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.js">
</script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/>
<!-- Pseudocode -->
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script>
<script>
        pseudocode.renderElement(document.getElementById("markov-localization"));
    </script>
<!-- UML diagrams using Mermaid -->
<script src="https://unpkg.com/mermaid@8.8.0/dist/mermaid.min.js"></script>
<script>
        mermaid.initialize({ startOnLoad: true, securityLevel: "loose" });
    </script>
<!-- Adsense -->
<script async="" crossorigin="anonymous" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2214309606626131"></script>
<!-- Cookie consent -->
<link href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" rel="stylesheet" type="text/css">
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-5Z9V7GPRX3"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-5Z9V7GPRX3",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-5Z9V7GPRX3",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
<script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
</link><link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                .gdesc-inner { font-size: 0.75rem; }
                body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
                body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
                body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
                </style><script src="../../../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="indigo" data-md-color-primary="white" data-md-color-scheme="default" dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#diffbot-base-package-low-level-approach">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="DiffBot Differential Drive Mobile Robot" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="DiffBot Differential Drive Mobile Robot">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DiffBot Differential Drive Mobile Robot
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Base Package - Low Level Approach
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="white" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="red" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="black" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"></path></svg>
</label>
</form>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ros-mobile-robots/diffbot" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-tabs__inner md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
      Home
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../technical_requirements/">
        Getting Started
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../hardware_setup/overview/">
        Hardware Setup
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../processing_units/">
        Processing Units
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link md-tabs__link--active" href="../../">
        ROS Software Packages
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../theory/">
        Robotics Theory
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../theory/motion-and-odometry/">
        Hardware and Theory
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../insiders/">
      Insiders
    </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DiffBot Differential Drive Mobile Robot" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="DiffBot Differential Drive Mobile Robot">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    DiffBot Differential Drive Mobile Robot
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ros-mobile-robots/diffbot" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
        Home
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Getting Started" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../technical_requirements/">
        Technical Requirements
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/">
        Components
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3">
          Hardware Setup
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Hardware Setup" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
          Hardware Setup
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../hardware_setup/overview/">
        Hardware Setup Overview
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../hardware_setup/3D_print/">
        3D Printing
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../hardware_setup/electronics/">
        Electronics
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../hardware_setup/assembly/">
        Assembly
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../hardware_setup/install/">
        Install
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" id="__nav_4" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../processing_units/">Processing Units</a>
<label for="__nav_4">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Processing Units" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
          Processing Units
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" id="__nav_4_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_2">
          Single Board Computer
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Single Board Computer" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_2">
<span class="md-nav__icon md-icon"></span>
          Single Board Computer
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../processing_units/rpi-setup/">
        Raspberry Pi Setup
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../processing_units/jetson-nano-setup/">
        Jetson Nano Setup
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../processing_units/git-setup/">
        Git Setup
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../processing_units/ros-setup/">
        ROS Setup
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../processing_units/teensy-mcu/">
        Microcontroller
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../processing_units/hardware-interfaces/">
        Hardware Interfaces
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../processing_units/ros-network-setup/">
        ROS Network Setup
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../">ROS Software Packages</a>
<label for="__nav_5">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="ROS Software Packages" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
          ROS Software Packages
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../packages-setup/">
        Packages Setup
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../diffbot_robot/">
        Robot Package
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_4" id="__nav_5_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_4">
          Robot Description
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Robot Description" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_4">
<span class="md-nav__icon md-icon"></span>
          Robot Description
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../robot-description/">
        Robot Description
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../remo_description/">
        Remo Description
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../diffbot_gazebo/">
        Simulation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../diffbot_control/">
        Control
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_7" id="__nav_5_7" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../">Base Hardware Interface</a>
<label for="__nav_5_7">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Base Hardware Interface" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_7">
<span class="md-nav__icon md-icon"></span>
          Base Hardware Interface
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../pid/">
        PID Controllers
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Low-Level PID Approach
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Low-Level PID Approach
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#implementing-the-low-level-base-controller-for-remo">
    Implementing the low-level base controller for Remo
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ros-control-high-level-hardware-interface-for-a-differential-drive-robot">
    ROS Control high-level hardware interface for a differential drive robot
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../high-level/">
        High-Level PID Approach
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../diffbot_msgs/">
        Messages
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../grove_motor_driver/">
        Motor Driver
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../DG01D-E-motor-with-encoder/">
        Motor and Encoder
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../diffbot_navigation/">
        Navigation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../diffbot_slam/">
        SLAM
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../diffbot_mbf/">
        Move Base Flex
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../diffbot_bringup/">
        Hardware Bringup
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../raspicam_node/">
        Rasperry Pi Camera
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_16" id="__nav_5_16" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_16">
          Inertial Measurement Unit
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Inertial Measurement Unit" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_16">
<span class="md-nav__icon md-icon"></span>
          Inertial Measurement Unit
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../imu/robot_localization/">
        Robot Localization
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../imu/driver-bno055/">
        BNO055 Driver
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" id="__nav_6" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../theory/">Robotics Theory</a>
<label for="__nav_6">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Robotics Theory" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
          Robotics Theory
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" id="__nav_6_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_2">
          Preliminaries
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Preliminaries" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_2">
<span class="md-nav__icon md-icon"></span>
          Preliminaries
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/preliminaries/linear-algebra/">
        Linear Algebra
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/preliminaries/probability/">
        Probability
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/preliminaries/programming/">
        Programming
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" id="__nav_6_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_3">
          Modeling and Control
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Modeling and Control" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_3">
<span class="md-nav__icon md-icon"></span>
          Modeling and Control
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/modeling-control/control-systems-introduction/">
        Introduction to Control Systems
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/modeling-control/robot-representations/">
        Representations and models
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/modeling-control/modeling-differential-drive-robot/">
        Modeling a Differential Drive Robot
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/modeling-control/odometry/">
        Odometry
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" id="__nav_6_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_4">
          Robot Vision
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Robot Vision" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_4">
<span class="md-nav__icon md-icon"></span>
          Robot Vision
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/robot-vision/pinhole-camera-model/">
        Pinhole Camera Model
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/robot-vision/camera-calibration/">
        Camera Calibration
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/robot-vision/image-processing/">
        Image Processing
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/robot-vision/features-and-segmentation/">
        Features and Segmentation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/robot-vision/tracking-image-features/">
        Tracking Image Features
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/robot-vision/combining-camera-and-lidar/">
        Combining Camera and Lidar
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/object-detection/overview.md">
        Object Detection
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_6" id="__nav_6_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_6">
          State Estimation
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="State Estimation" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_6">
<span class="md-nav__icon md-icon"></span>
          State Estimation
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/state-estimation/recursive-state-estimation/">
        Recursive State Estimation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/state-estimation/gaussian-filters.md">
        Gaussian Filters (Kalman Filter)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/state-estimation/nonparametric-filters/">
        Nonparametric Filters (Particle Filter)
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_7" id="__nav_6_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_7">
          Localization
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Localization" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_7">
<span class="md-nav__icon md-icon"></span>
          Localization
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/localization/markov-and-gaussian-localization/">
        Markov and Gaussian Localization
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/localization/grid-and-monte-carlo-localization.md">
        Grid and Monte Carlo Localization
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_8" id="__nav_6_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_8">
          Mapping
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Mapping" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_8">
<span class="md-nav__icon md-icon"></span>
          Mapping
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/mapping/occupancy-grid-mapping.md">
        Occupancy Grid Mapping
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_9" id="__nav_6_9" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_9">
          Simultaneous Localization and Mapping (SLAM)
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Simultaneous Localization and Mapping (SLAM)" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_9">
<span class="md-nav__icon md-icon"></span>
          Simultaneous Localization and Mapping (SLAM)
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/slam/slam-overview/">
        SLAM Overview
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/slam/1.%20Robot%20Moving%20and%20Sensing/">
        Robot Class
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/slam/2.%20Omega%20and%20Xi%2C%20Constraints/">
        Omega and Xi Constraints Notebook
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/slam/3.%20Landmark%20Detection%20and%20Tracking/">
        Project 3:  Implement SLAM
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/slam/ekf-slam.md">
        EKF SLAM
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/slam/graphslam.md">
        GraphSLAM
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/slam/fastslam.md">
        FastSLAM
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/slam/gmapping.md">
        GMapping
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/planning1/overview.md">
        Planning I
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/planning2/overview.md">
        Planning II
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/reinforcement-learning/overview.md">
        Learning by Reinforcement
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/imitation-learning/overview.md">
        Learning by Imitation
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" id="__nav_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_7">
          Hardware and Theory
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Hardware and Theory" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
          Hardware and Theory
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../theory/motion-and-odometry/">
        Motion and Odometry
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../power-supply/">
        Power Supply
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../laser-range-scanner/">
        Laser Range Scanner
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../insiders/">
        Insiders
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#implementing-the-low-level-base-controller-for-remo">
    Implementing the low-level base controller for Remo
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ros-control-high-level-hardware-interface-for-a-differential-drive-robot">
    ROS Control high-level hardware interface for a differential drive robot
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/ros-mobile-robots/ros-mobile-robots.github.io/tree/main/docs/packages/diffbot_base/low-level.md" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"></path></svg>
</a>
<h1 id="diffbot-base-package-low-level-approach">DiffBot Base Package - Low Level Approach</h1>
<p>Having explained the two components of the base
controller in <a href="../">DiffBot Base</a>, the low-level firmware is implemented first, followed by the high-level hardware, detailed in the next section.</p>
<h2 id="implementing-the-low-level-base-controller-for-remo">Implementing the low-level base controller for Remo</h2>
<p>The low-level base controller is implemented on the Teensy microcontroller using
<a href="https://platformio.org/">PlatformIO</a>. The programming language in PlatformIO is
the same as Arduino (based on Wiring) and it is available as a plugin for the
Visual Studio Code editor. On the development PC, we can flash the robot
firmware to the board with this plugin. We will get the firmware code from the
<code>diffbot_base</code> ROS package, located in the
<a href="https://github.com/ros-mobile-robots/diffbot/tree/noetic-devel/diffbot_base/scripts/base_controller"><code>scripts/base_controller</code></a>
subfolder. Opening this folder in Visual Studio Code will recognize it as a
PlatformIO workspace because it contains the <code>platformio.ini</code> file. This file
defines the required dependencies and makes it straightforward to flash the
firmware to the Teensy board after compilation. Inside this file, the used
libraries are listed:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="go">lib_deps = frankjoshua/Rosserial Arduino Library@^0.9.1</span>
<span class="go">           adafruit/Adafruit Motor Shield V2 Library@^1.0.11</span>
<span class="go">           Wire</span>
</code></pre></div></td></tr></table></div>
<p>As you can see, the firmware depends on <code>rosserial</code>, the <code>Adafruit Motor Shield
V2</code> library, and <code>Wire</code>, an I2C library. PlatformIO allows using custom
libraries defined in the local <code>./lib</code> folder, which are developed in this
section.</p>
<p>The firmware is used to read from encoders and ultrasonic and IMU sensors, and
receive wheel velocity commands from the high-level
<code>hardware_interface::RobotHW</code> class, discussed in the next section. The
following code snippets are part of the low-level base controller’s <code>main.cpp</code>
file and show the used libraries, found in
<code>diffbot_base/scripts/base_controller</code>, in the <code>lib</code> and <code>src</code> folders. <code>src</code>
contains <code>main.cpp</code> consisting of the <code>setup()</code> and <code>loop()</code> functions, common
to every Arduino sketch and starts off by including the following headers:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ros.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"diffbot_base_config.h"</span><span class="cp"></span>
</code></pre></div></td></tr></table></div>
<p>Besides the ros header file, it includes definitions specific to Remo, which are
defined in the <code>diffbot_base_config.h</code> header. It contains constant parameter
values such as the following:</p>
<ul>
<li>Encoder pins: Defines to which pins on the Teensy microcontroller the Hall
  effect sensors are connected.</li>
<li>Motor I2C address and pins: The Adafruit motor driver can drive four DC
  motors. Due to cable management, motor terminals <code>M3</code> and <code>M4</code> are used for
  the left and right motors, respectively.</li>
<li>PID: The tuned constants for both PID controllers of <code>base_controller</code>.</li>
<li>PWM_MAX and PWM_MIN: The minimum and maximum possible PWM values that can be
  sent to the motor driver.</li>
<li>Update rates: Defines how often functions of <code>base_controller</code> are executed.
  For example, the control portion of the low-level base controller code reads
  encoder values and writes motor commands at a specific rate.</li>
</ul>
<p>After including Remo-specific definitions, next follows the custom libraries in
the <code>lib</code> folder:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>```cpp
#include "base_controller.h"
#include "adafruit_feather_wing/adafruit_feather_wing.h"
```
</code></pre></div></td></tr></table></div>
<p>These include directives and the libraries that get included with them are
introduced next:</p>
<ul>
<li><code>base_controller</code>: Defines the <code>BaseController</code> template class, defined in the
  <code>base_controller.h</code> header, and acts as the main class to manage the two
  motors, including each motor’s encoder, and communicate with the high-level
  hardware interface.</li>
<li><code>motor_controller_intf</code>: This library is indirectly included with
  <code>adafruit_feather_wing.h</code> and defines an abstract base class, named
  <code>MotorControllerIntf</code>. It is a generic interface used to operate a single
  motor using arbitrary motor drivers. It is meant to be implemented by other
  specific motor controller subclasses and therefore avoids changing code in
  classes that know the <code>MotorControllerIntf</code> interface and call its
  <code>setSpeed(int value)</code> method, such as done by <code>BaseController</code>. The only
  requirement for this to work is for a subclass to inherit from this
  <code>MotorControllerIntf</code> interface and implement the <code>setSpeed(int value)</code> class
  method.</li>
<li><code>adafruit_feather_wing</code>: This library, in the <code>motor_controllers</code> folder,
  implements the <code>MotorControllerIntf</code> abstract interface class and defines a
  concrete motor controller. For Remo, the motor controller is defined in the
  <code>AdafruitMotorController</code> class. This class has access to the motor driver
  board and serves to operate the speed of a single motor, which is why two
  instances are created in the <code>main.cpp</code> file.</li>
<li>
<p><code>encoder</code>: This library is used in the <code>BaseController</code> class and is based on
  <code>Encoder.h</code> from <a href="https://www.pjrc.com/teensy/td_libs_Encoder.html">https://www.pjrc.com/teensy/td_libs_Encoder.html</a> that allows
  reading encoder tick counts from quadrature encoders, like the DG01D-E motors
  consist of. The encoder library also provides a method <code>jointState()</code> to
  directly obtain the joint state, which is returned by this method in the
  <code>JointState</code> struct, that consists of the measured angular position (rad) and
  angular velocity (rad/s) of the wheel joints:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">diffbot</span><span class="o">::</span><span class="n">JointState</span><span class="w"> </span><span class="nf">diffbot::Encoder::jointState</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">encoder_ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encoder</span><span class="p">.</span><span class="n">read</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">ros</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="n">current_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nh_</span><span class="p">.</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">ros</span><span class="o">::</span><span class="n">Duration</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prev_update_time_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dt</span><span class="p">.</span><span class="n">toSec</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">delta_ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encoder_ticks</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prev_encoder_ticks_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">delta_angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ticksToAngle</span><span class="p">(</span><span class="n">delta_ticks</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">joint_state_</span><span class="p">.</span><span class="n">angular_position_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">delta_angle</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">joint_state_</span><span class="p">.</span><span class="n">angular_velocity_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delta_angle</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dts</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">prev_update_time_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_time</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">prev_encoder_ticks_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encoder_ticks</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">joint_state_</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
</li>
<li>
<p><code>pid</code>: Defines a PID controller to compute PWM signals based on the velocity
  error between measured and commanded angular wheel joint velocities. For more
  infos about PIDs and the tuning sections refer to <a href="../pid/">PID Controllers</a></p>
</li>
</ul>
<p>With these libraries, we look at the <code>main.cpp</code> file. Inside it exists only a
few global variables to keep the code organized and make it possible to test the
individual components that get included. The main code is explained next:</p>
<ol>
<li>
<p>First, we define the global ROS node handle, which is referenced in other
   classes, such as BaseController, where it is needed to publish, subscribe, or
   get the current time, using <code>ros::NodeHandle::now()</code>, to keep track of the
   update rates:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="w"> </span><span class="n">nh</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>For convenience and to keep the code organized, we declare that we want to
   use the <code>diffbot</code> namespace, where the libraries of the base controller are
   declared:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">diffbot</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>Next, we define two concrete motor controllers of type
   <code>AdafruitMotorController</code> found in the <code>motor_controllers</code> library:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">AdafruitMotorController</span><span class="w"> </span><span class="n">motor_controller_right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AdafruitMotorController</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="n">AdafruitMotorController</span><span class="w"> </span><span class="n">motor_controller_left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AdafruitMotorController</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>This class inherits from the abstract base class <code>MotorControllerIntf</code>,
explained above. It knows how to connect to the Adafruit motor driver using its
open source <code>Adafruit_MotorShield</code> library
(<a href="https://learn.adafruit.com/adafruit-stepper-dc-motor-featherwing/library-reference">https://learn.adafruit.com/adafruit-stepper-dc-motor-featherwing/library-reference</a>)
and how to get a C++ pointer to one of its DC motors (<code>getMotor(motor_num)</code>).
Depending on the integer input value to <code>AdafruitMotorController::setSpeed(int
value)</code>, the DC motor is commanded to rotate in a certain direction and at a
specified speed. For Remo, the range is between –255 and 255, specified by the
<code>PWM_MAX</code> and <code>PWM_MIN</code> identifiers.</p>
</li>
<li>
<p>The next class that is defined globally inside main is <code>BaseController</code>,
   which incorporates most of the main logic of this low-level base controller:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">BaseController</span><span class="o">&lt;</span><span class="n">AdafruitMotorController</span><span class="p">,</span><span class="w"> </span><span class="n">Adafruit_MotorShield</span><span class="o">&gt;</span><span class="w"> </span><span class="n">base_controller</span><span class="p">(</span><span class="n">nh</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">motor_controller_left</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">motor_controller_right</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>As you can see, it is a template class that accepts different kinds of motor
controllers (<code>TMotorController</code>, which equals <code>AdafruitMotorController</code> in the
case of Remo) that operate on different motor drivers (<code>TMotorDriver</code>, which
equals <code>Adafruit_MotorShield</code>), using the <code>MotorControllerIntf</code> interface as
explained previously. The <code>BaseController</code> constructor takes a reference to the
globally defined ROS node handle and the two motor controllers to let it set the
commanded speeds computed through two separate PID controllers, one for each
wheel.</p>
<p>In addition to setting up pointers to the motor controllers, the
<code>BaseController</code> class initializes two instances of type <code>diffbot::Encoder</code>. Its
measured joint state, returned from <code>diffbot::Encoder::jointState()</code>, is used
together with the commanded wheel joint velocities in the <code>diffbot::PID</code>
controllers to compute the velocity error and output an appropriate PWM signal
for the motors.</p>
</li>
</ol>
<p>After defining the global instances, the firmware’s <code>setup()</code> function is
discussed next. The low-level BaseController class communicates with the
high-level interface <code>DiffBotHWInterface</code> using ROS publishers and subscribers.
These are set up in the <code>Basecontroller::setup()</code> method, which is called in the
<code>setup()</code> function of <code>main.cpp</code>. In addition to that, the
<code>BaseController::init()</code> method is here to read parameters stored on the ROS
parameter server, such as the wheel radius and distance between the wheels.
Beside initializing <code>BaseController</code>, the communication frequency of the motor
driver is configured:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">base_controller</span><span class="p">.</span><span class="n">setup</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">base_controller</span><span class="p">.</span><span class="n">init</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">motor_controller_left</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">motor_controller_right</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>The <code>begin(uint16_t freq)</code> method of the motor controllers has to be called
explicitly in the main <code>setup()</code> function because <code>MotorControllerIntf</code> doesn't
provide a <code>begin()</code> or <code>setup()</code> method in its interface. This is a design
choice that, when added, would make the <code>MotorControllerIntf</code> less generic.</p>
<p>After the <code>setup()</code> function follows the <code>loop()</code> function, to read from sensors
and write to actuators, which happens at specific rates, defined in the
<code>diffbot_base_config.h</code> header. The bookkeeping of when these read/write
functionalities occurred is kept in the <code>BaseController</code> class inside its
<code>lastUpdateRates</code> struct. Reading from the encoders and writing motor commands
happens in the same code block as the control rate:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">ros</span><span class="o">::</span><span class="n">Duration</span><span class="w"> </span><span class="n">command_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nh</span><span class="p">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">base_controller</span><span class="p">.</span><span class="n">lastUpdateTime</span><span class="p">().</span><span class="n">control</span><span class="p">;</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">command_dt</span><span class="p">.</span><span class="n">toSec</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">ros</span><span class="o">::</span><span class="n">Duration</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">base_controller</span><span class="p">.</span><span class="n">publishRate</span><span class="p">().</span><span class="n">control_</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">).</span><span class="n">toSec</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">base_controller</span><span class="p">.</span><span class="n">read</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">base_controller</span><span class="p">.</span><span class="n">write</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">base_controller</span><span class="p">.</span><span class="n">lastUpdateTime</span><span class="p">().</span><span class="n">control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nh</span><span class="p">.</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>The following steps in this code block happen continuously at the control rate:</p>
<ol>
<li>Encoder sensor values are read through the <code>BaseController::read()</code> method
   and the data is published inside this method for the high-level
   <code>DiffbotHWInterface</code> class, on the <code>measured_joint_states</code> topic of message
   type <code>sensor_msgs::JointState</code>.</li>
<li>The <code>BaseController</code> class subscribes to <code>DiffBotHWInterface</code> from which it
   receives the commanded wheel joint velocities (topic <code>wheel_cmd_velocities</code>,
   type <code>diffbot_msgs::WheelsCmdStamped</code>) inside the
   <code>BaseController::commandCallback(const diffbot_msgs::WheelsCmdStamped&amp;)</code>
   callback method. In <code>BaseController::read()</code>, the PID is called to compute
   the motor PWM signals from the velocity error and the motor speeds are set
   with the two motor controllers.</li>
<li>To keep calling this method at the desired control rate, the
   <code>lastUpdateTime().control</code> variable is updated with the current time.</li>
</ol>
<p>After the control loop update block, if an IMU is used, its data could be read
at the imu rate and published for a node that fuses the data with the encoder
odometry to obtain more precise odometry. Finally, in the main <code>loop()</code>, all the
callbacks waiting in the ROS callback queue are processed with a call to
<code>nh.spinOnce()</code>.</p>
<p>MThis describes the low-level base controller. For more details and the complete
library code, please refer to the <code>diffbot_base/scripts/base_controller</code>
package. </p>
<p>In the following section, the <code>diffbot::DiffBotHWInterface</code> class is described.</p>
<h2 id="ros-control-high-level-hardware-interface-for-a-differential-drive-robot">ROS Control high-level hardware interface for a differential drive robot</h2>
<p>The <a href="http://wiki.ros.org/ros_control">ros_control</a> meta package contains the
hardware interface class <code>hardware_interface::RobotHW</code>, which needs to be
implemented to leverage many available controllers from the <code>ros_controllers</code>
meta package. First, we’ll look at the <code>diffbot_base</code> node that instantiates and
uses the hardware interface:</p>
<ol>
<li>
<p>The <code>diffbot_base</code> node includes the <code>diffbot_hw_interface.h</code> header, as well
   as the <code>controller_manager</code>, defined in <code>controller_manager.h</code>, to create the
   control loop (read, update, write):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ros/ros.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;diffbot_base/diffbot_hw_interface.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;controller_manager/controller_manager.h&gt;</span><span class="cp"></span>
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>Inside the main function of this <code>diffbot_base</code> node, we define the ROS node
   handle, the hardware interface (<code>diffbot_base::DiffBotHWInterface</code>), and pass
   it to the <code>controller_manager</code>, so that it has access to its resources:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="w"> </span><span class="n">nh</span><span class="p">;</span><span class="w"></span>
<span class="n">diffbot_base</span><span class="o">::</span><span class="n">DiffBotHWInterface</span><span class="w"> </span><span class="nf">diffBot</span><span class="p">(</span><span class="n">nh</span><span class="p">);</span><span class="w"></span>
<span class="n">controller_manager</span><span class="o">::</span><span class="n">ControllerManager</span><span class="w"> </span><span class="nf">cm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diffBot</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>Next, set up a separate thread that will be used to service ROS callbacks.
   This runs the ROS loop in a separate thread as service callbacks can block
   the control loop:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">ros</span><span class="o">::</span><span class="n">AsyncSpinner</span><span class="w"> </span><span class="nf">spinner</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="n">spinner</span><span class="p">.</span><span class="n">start</span><span class="p">();</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>Then define at which rate the control loop of the high-level hardware
   interface should run. For Remo, we choose 10 Hz:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">ros</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="n">prev_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ros</span><span class="o">::</span><span class="n">Time</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="n">ros</span><span class="o">::</span><span class="n">Rate</span><span class="w"> </span><span class="nf">rate</span><span class="p">(</span><span class="mf">10.0</span><span class="p">);</span><span class="w"> </span><span class="n">rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">();</span><span class="w"> </span><span class="c1">// 10 Hz rate</span>
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>Inside the blocking while loop of the <code>diffbot_base</code> node, we do basic
   bookkeeping to get the system time to compute the control period:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">ros</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ros</span><span class="o">::</span><span class="n">Time</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">ros</span><span class="o">::</span><span class="n">Duration</span><span class="w"> </span><span class="n">period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prev_time</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">prev_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>Next, we execute the control loop steps: read, update, and write. The
   <code>read()</code> method is here to get sensor values, while <code>write()</code> writes commands
   that were computed by <code>diff_drive_controller</code> during the <code>update()</code> step:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="n">diffBot</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">period</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">cm</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">period</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">diffBot</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">period</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>These steps keep getting repeated with the specified rate using
   <code>rate.sleep()</code>.</p>
</li>
</ol>
<p>After having defined the code that runs the main control loop of the
<code>diffbot_base</code> node, we’ll take a look at the implementation of
<code>diffbot::DiffBotHWInterface</code>, which is a child class of
<code>hardware_interface::RobotHW</code>. With it, we register the hardware and implement
the <code>read()</code> and <code>write()</code> methods, used above in the control loop.</p>
<p>The constructor of the <code>diffbot::DiffBotHWInterface</code> class is used to get
parameters from the parameter server, such as the <code>diff_drive_controller</code>
configuration from the <code>diffbot_control</code> package. Inside the constructor, the
wheel command publisher and measured joint state subscriber are initialized.
Another publisher is <code>pub_reset_encoders_</code>, which is used in the
<code>isReceivingMeasuredJointStates</code> method to reset the encoder ticks to zero after
receiving measured joint states from the low-level base controller.</p>
<p>After constructing <code>DiffBotHWInterface</code>, we create instances of
<code>JointStateHandles</code> classes (used only for reading) and <code>JointHandle</code> classes
(used for read, and write access) for each controllable joint and register them
with the <code>JointStateInterface</code> and <code>VelocityJointInterface</code> interfaces,
respectively. This enables the <code>controller_manager</code> to manage access for joint
resources of multiple controllers. Remo uses <code>DiffDriveController</code> and
<code>JointStateController</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_joints_</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">hardware_interface</span><span class="o">::</span><span class="n">JointStateHandle</span><span class="w"> </span><span class="nf">joint_state_handle</span><span class="p">(</span><span class="n">joint_names_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">joint_positions_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">joint_velocities_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">joint_efforts_</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">joint_state_interface_</span><span class="p">.</span><span class="n">registerHandle</span><span class="p">(</span><span class="n">joint_state_handle</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">hardware_interface</span><span class="o">::</span><span class="n">JointHandle</span><span class="w"> </span><span class="nf">joint_handle</span><span class="p">(</span><span class="n">joint_state_handle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">joint_velocity_commands_</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">velocity_joint_interface_</span><span class="p">.</span><span class="n">registerHandle</span><span class="p">(</span><span class="n">joint_handle</span><span class="p">);</span><span class="w"> </span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>The last step that is needed to initialize the hardware resources is to register
the <code>JointStateInterface</code> and the <code>VelocityJointInterface</code> interfaces with the
robot hardware interface itself, thereby grouping the interfaces together to
represent Remo robot in software:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">registerInterface</span><span class="p">(</span><span class="o">&amp;</span><span class="n">joint_state_interface_</span><span class="p">);</span><span class="w"></span>
<span class="n">registerInterface</span><span class="p">(</span><span class="o">&amp;</span><span class="n">velocity_joint_interface_</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Now that the hardware joint resources are registered and the controller manager
knows about them, it’s possible to call the <code>read()</code> and <code>write()</code> methods of
the hardware interface. The controller manager update happens in between the
read and write steps. Remo subscribes to the <code>measured_joint_states</code> topic,
published by the low-level base controller. The received messages on this topic
are stored in the <code>measured_joint_states_ array</code> of type
<code>diffbot_base::JointState</code> using the <code>measuredJointStateCallback</code> method, and
are relevant in the <code>read()</code> method:</p>
<ol>
<li>
<p>The <code>read()</code> method is here to update the measured joint values with the current sensor readings from the encoders – angular positions (rad) and velocities (rad/s):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">DiffBotHWInterface::read</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_joints_</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">joint_positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">measured_joint_states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">angular_position</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">joint_velocity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">measured_joint_states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">angular_velocity</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>The final step of the control loop is to call the <code>write()</code> method of the <code>DiffBotHWInterface</code> class to publish the angular wheel velocity commands of each joint, computed by <code>diff_drive_controller</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">DiffBotHWInterface::write</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">diffbot_msgs</span><span class="o">::</span><span class="n">WheelsCmdStamped</span><span class="w"> </span><span class="n">wheel_cmd_msg</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NUM_JOINTS</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">wheel_cmd_msg</span><span class="p">.</span><span class="n">wheels_cmd</span><span class="p">.</span><span class="n">angular_velocities</span><span class="p">.</span><span class="n">joint</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">joint_velocity_commands_</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"> </span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">pub_wheel_cmd_velocities_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">wheel_cmd_msg</span><span class="p">);</span><span class="w"> </span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
</li>
</ol>
<p>In this method, it would be possible to correct for steering offsets due to
model imperfections and slight differences in the wheel radii. See <a href="../pid/#gain--trim-model">gain / trim
model</a>.</p>
<p>This concludes the important parts of the <code>DiffBotHWInterface</code> class and enables
Remo to satisfy the requirements to work with the ROS Navigation Stack. In the
next section, we’ll look at how to bring up the robot hardware and how the
started nodes interact with each other.</p>
</article>
</div>
</div>
<a class="md-top md-icon" data-md-component="top" hidden="" href="#">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg>
            Back to top
          </a>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: PID Controllers" class="md-footer__link md-footer__link--prev" href="../pid/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              PID Controllers
            </div>
</div>
</a>
<a aria-label="Next: High-Level PID Approach" class="md-footer__link md-footer__link--next" href="../high-level/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              High-Level PID Approach
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2021 - 2021 Franz Pucher | <a href="https://www.ros-mobile-robots.com/privacy-policy/">Privacy Policy</a> | <a href="https://www.ros-mobile-robots.com/legal-notice/">Legal Notice</a>
</div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.top", "navigation.indexes"], "search": "../../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
<script src="../../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
<script src="https://gumroad.com/js/gumroad.js"></script>
<script>
        $(document).ready(function(){
            // Target your .container, .wrapper, .post, etc.
            $(".md-main").fitVids();
        });
    </script>
<!-- cookie consent -->
<script data-cfasync="false" src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"></script>
<script>
    window.cookieconsent.initialise({
    "palette": {
        "popup": {
        "background": "#edeff5",
        "text": "#838391"
        },
        "button": {
        "background": "#4b81e8"
        }
    },
    "theme": "classic"
    });
    </script>
<script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>